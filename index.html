<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Anki Dialogue â†’ CSV (17 fields, pipe, ID first)</title>
<style>
  :root { --pad:16px; }
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Arial,sans-serif;margin:var(--pad);}
  h1{font-size:22px;margin:0 0 8px}
  .hint{color:#555;font-size:14px;margin-bottom:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .btn{padding:12px 16px;border:1px solid #ccc;border-radius:10px;background:#f4f4f6;cursor:pointer;font-size:16px}
  .btn.primary{background:#0b5fff;border-color:#0b5fff;color:#fff}
  .btn:active{transform:translateY(1px)}
  textarea{width:100%;height:50vh;padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:15px;line-height:1.5;border:1px solid #ddd;border-radius:10px}
  .status{font-size:14px;color:#444}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{border:1px solid #eee;padding:6px;vertical-align:top}
  th{background:#fafafa;text-align:left}
  .warn{color:#b00020}
  .muted{color:#666}
</style>
</head>
<body>
  <h1>Anki Dialogue â†’ CSV (17 fields)</h1>
  <div class="hint">
    Xuáº¥t <b>17 cá»™t (khÃ´ng header)</b> vá»›i <b>delimiter = â€œ|â€</b>:<br>
    <code>1:ID â€¢ 2â€“5:(empty) â€¢ 6â€“11: EN A1..B3 â€¢ 12â€“17: JP A1..B3</code>
  </div>

  <div class="row">
    <button class="btn" id="btnExample">DÃ¡n vÃ­ dá»¥</button>
    <button class="btn" id="btnPreview">Preview</button>
    <button class="btn primary" id="btnDownload">Táº£i CSV</button>
    <span class="status" id="status">0/0 há»™i thoáº¡i há»£p lá»‡</span>
  </div>

  <textarea id="input" placeholder="ğŸ‘¥ æ—¥æœ¬èª
A: ...
B: ...
...
ğŸ’¬ English
A: ...
B: ...
...

ğŸ‘¥ æ—¥æœ¬èª
A: ...
B: ...
...
ğŸ’¬ English
A: ...
B: ...
..."></textarea>

  <div id="preview"></div>

<script>
// ===== Helpers =====
function norm(s){return (s||"").replace(/\r\n/g,"\n").replace(/\r/g,"\n");}
function escapeHTML(x){return String(x??"").replace(/&/g,"&amp;").replace(/</g,"&lt;");}

// TÃ¡ch má»—i há»™i thoáº¡i báº¯t Ä‘áº§u táº¡i dÃ²ng cÃ³ 'æ—¥æœ¬èª'
function splitBlocks(all){
  const t = norm(all).trim();
  if(!t) return [];
  return t.split(/(?=^[ \t]*(?:ğŸ‘¥\s*)?æ—¥æœ¬èª[ \t]*$)/m).filter(x=>x.trim());
}

function extractSection(lines, headerRegex){
  let start = -1;
  for(let i=0;i<lines.length;i++){
    if(headerRegex.test(lines[i])){ start = i+1; break; }
  }
  if(start<0) return [];
  const out=[];
  for(let i=start;i<lines.length;i++){
    const line = lines[i];
    if(/^[ \t]*(?:ğŸ‘¥\s*)?æ—¥æœ¬èª[ \t]*$/.test(line) || /^[ \t]*(?:ğŸ’¬\s*)?English[ \t]*$/i.test(line)){
      break;
    }
    out.push(line);
  }
  return out;
}

// Láº¥y lÆ°á»£t A/B tá»‘i Ä‘a 3 cáº·p, thiáº¿u thÃ¬ Ä‘iá»n ""
function pickTurns(sectionLines){
  const turns=[];
  for(const raw of sectionLines){
    const m = raw.match(/^\s*([AB])\s*:\s*(.+)\s*$/);
    if(m){ turns.push({speaker:m[1], text:m[2]}); }
  }
  const out = Array(6).fill("");
  let a=0,b=0;
  for(const t of turns){
    if(t.speaker==="A" && a<3){ out[2*a] = t.text; a++; }
    if(t.speaker==="B" && b<3){ out[2*b+1] = t.text; b++; }
  }
  return out;
}

// Parse 1 block â†’ row 17 cá»™t (cÃ³ ID á»Ÿ cá»™t 1)
function parseOneBlock(blockText, idx1){
  const lines = norm(blockText).split("\n").map(s=>s.trimEnd());
  const jpLines = extractSection(lines, /^[ \t]*(?:ğŸ‘¥\s*)?æ—¥æœ¬èª[ \t]*$/);
  const enLines = extractSection(lines, /^[ \t]*(?:ğŸ’¬\s*)?English[ \t]*$/i);

  if(!jpLines.length || !enLines.length) {
    return { ok:false, reason:"Thiáº¿u pháº§n æ—¥æœ¬èª hoáº·c English", row:null };
  }

  const jp6 = pickTurns(jpLines);
  const en6 = pickTurns(enLines);

  // Ãt nháº¥t cáº§n EN A1/B1
  const hasPair = (en6[0] && en6[1]);

  // 17 cá»™t: 1=ID, 2â€“5 blank, 6â€“11 EN, 12â€“17 JP
  const row = Array(17).fill("");
  row[0] = String(idx1); // ID tá»± tÄƒng (1-based)
  for(let i=0;i<6;i++){ row[5+i]  = en6[i]; }  // 6..11
  for(let i=0;i<6;i++){ row[11+i] = jp6[i]; }  // 12..17

  return { ok: hasPair, reason: hasPair?"":"Thiáº¿u cáº·p EN A1/B1", row };
}

function parseAll(input){
  const blocks = splitBlocks(input);
  const rows=[]; const issues=[];
  let counter = 1;
  blocks.forEach((blk, idx)=>{
    const r = parseOneBlock(blk, counter);
    if(r.ok){ rows.push(r.row); counter++; }
    else { issues.push({index:idx+1, reason:r.reason}); }
  });
  return { rows, issues, total: blocks.length };
}

// Xuáº¥t khÃ´ng header, delimiter = '|'
function toPipe(rows){
  const esc = v=>{
    const s=String(v??"");
    // Náº¿u cÃ³ | hoáº·c xuá»‘ng dÃ²ng â†’ quote theo CSV rule
    return (s.includes("|") || s.includes("\n")) ? `"${s.replace(/"/g,'""')}"` : s;
  };
  return rows.map(r=>r.map(esc).join("|")).join("\n");
}

function downloadFile(filename, text){
  const blob = new Blob(["\uFEFF"+text], {type:"text/plain;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); },0);
}

// ===== UI =====
const EXAMPLE = `ğŸ‘¥ æ—¥æœ¬èª
A: æ˜æ—¥æ™‚é–“ã‚ã‚‹ï¼Ÿ
B: ã†ã‚“ã€åˆå¾Œãªã‚‰å¤§ä¸ˆå¤«ã€‚
A: æ˜ ç”»è¦‹ã«è¡Œã‹ãªã„ï¼Ÿ
B: ã„ã„ã­ï¼ä½•æ™‚ã«ã™ã‚‹ï¼Ÿ

ğŸ’¬ English
A: Are you free tomorrow?
B: Yeah, afternoon works.
A: Want to go see a movie?
B: Sounds good! What time?

ğŸ‘¥ æ—¥æœ¬èª
A: ã¡ã‚‡ã£ã¨ç†±ã£ã½ã„ã‚“ã ã‘ã©ã€ä»Šæ—¥ç—…é™¢ã«è¡Œã£ãŸã»ã†ãŒã„ã„ã‹ãªï¼Ÿ
B: ã†ã‚“ã€ãã®ã»ã†ãŒã„ã„ã¨æ€ã†ã‚ˆã€‚é ­ç—›ã¨ã‹ã¯ã‚ã‚‹ï¼Ÿ
A: å°‘ã—ã ã‘ã€‚ã‚ã¨ã€æ˜¨æ—¥ã‹ã‚‰å–‰ã‚‚ç—›ã„ã‚“ã ã€‚
B: ã˜ã‚ƒã‚ã€å†…ç§‘ã«è¡Œãã¨ã„ã„ã‚ˆã€‚è¿‘ãã«ã„ã„ç—…é™¢ãŒã‚ã‚‹ã‚ˆã€‚
A: ã‚ã‚ŠãŒã¨ã†ã€‚äºˆç´„ãŒå¿…è¦ã‹ãªï¼Ÿ
B: åˆå‰ä¸­ãªã‚‰äºˆç´„ãªã—ã§ã‚‚è¨ºã¦ã‚‚ã‚‰ãˆã‚‹ã¯ãšã ã‚ˆã€‚

ğŸ’¬ English
A: I feel a bit feverish. Do you think I should go to the hospital today?
B: Yeah, I think thatâ€™s a good idea. Do you have a headache, too?
A: A little. And my throat has been sore since yesterday.
B: Then you should go to the internal medicine department. Thereâ€™s a good clinic nearby.
A: Thanks. Do I need to make an appointment?
B: If you go in the morning, they should see you without one.
`;

const $input = document.getElementById("input");
const $status = document.getElementById("status");
const $preview = document.getElementById("preview");

function renderPreview(rows, issues){
  if(!rows.length){
    $preview.innerHTML = issues.length
      ? `<div class="warn">KhÃ´ng cÃ³ há»™i thoáº¡i há»£p lá»‡. Lá»—i: ${issues.map(i=>`#${i.index} (${i.reason})`).join("; ")}</div>`
      : "";
    return;
  }
  const head = `<tr>
    <th>#ID</th>
    <th>EN A1</th><th>EN B1</th><th>EN A2</th><th>EN B2</th><th>EN A3</th><th>EN B3</th>
    <th>JP A1</th><th>JP B1</th><th>JP A2</th><th>JP B2</th><th>JP A3</th><th>JP B3</th>
  </tr>`;
  const body = rows.slice(0,5).map((r)=>{
    const id = r[0];
    const cells = r.slice(5).map(c=>`<td>${escapeHTML(c)}</td>`).join("");
    return `<tr><td class="muted">${escapeHTML(id)}</td>${cells}</tr>`;
  }).join("");
  const issueNote = issues.length ? `<div class="warn">Bá» qua ${issues.length} há»™i thoáº¡i lá»—i</div>` : "";
  $preview.innerHTML = `<table>${head}${body}</table><div class="status">Xem trÆ°á»›c tá»‘i Ä‘a 5 há»™i thoáº¡i â€¢ Tá»•ng há»£p lá»‡: ${rows.length}</div>${issueNote}`;
}

function currentParsed(){ return parseAll($input.value); }

document.getElementById("btnExample").addEventListener("click", ()=>{
  $input.value = EXAMPLE;
  const {rows,issues,total} = currentParsed();
  $status.textContent = `${rows.length}/${total} há»™i thoáº¡i há»£p lá»‡`;
  renderPreview(rows, issues);
});
document.getElementById("btnPreview").addEventListener("click", ()=>{
  const {rows,issues,total} = currentParsed();
  $status.textContent = `${rows.length}/${total} há»™i thoáº¡i há»£p lá»‡`;
  renderPreview(rows, issues);
});
document.getElementById("btnDownload").addEventListener("click", ()=>{
  const {rows,issues,total} = currentParsed();
  if(!rows.length){ alert("KhÃ´ng cÃ³ há»™i thoáº¡i há»£p lá»‡ Ä‘á»ƒ xuáº¥t."); return; }
  const text = toPipe(rows);
  downloadFile("anki_dialogue_17fields_pipe.csv", text);
});
$input.addEventListener("input", ()=>{
  const {rows,total} = currentParsed();
  $status.textContent = `${rows.length}/${total} há»™i thoáº¡i há»£p lá»‡`;
});
</script>
</body>
</html>
