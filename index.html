<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Anki Dialogue ‚Üí CSV (18 fields) ‚Äî Smart Split</title>
<style>
  :root { --pad:16px; }
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Arial,sans-serif;margin:var(--pad);}
  h1{font-size:22px;margin:0 0 8px}
  .hint{color:#555;font-size:14px;margin-bottom:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .btn{padding:12px 16px;border:1px solid #ccc;border-radius:10px;background:#f4f4f6;cursor:pointer;font-size:16px}
  .btn.primary{background:#0b5fff;border-color:#0b5fff;color:#fff}
  .btn:active{transform:translateY(1px)}
  textarea{width:100%;height:50vh;padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:15px;line-height:1.5;border:1px solid #ddd;border-radius:10px}
  .status{font-size:14px;color:#444}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{border:1px solid #eee;padding:6px;vertical-align:top}
  th{background:#fafafa;text-align:left}
  .warn{color:#b00020}
  .ok{color:#256c2c}
  .muted{color:#666}
  .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#eee;font-size:12px;margin-left:6px}
</style>
</head>
<body>
  <h1>Anki Dialogue ‚Üí CSV (18 fields)</h1>
  <div class="hint">
    Xu·∫•t <b>CSV 18 c·ªôt (kh√¥ng header)</b> theo th·ª© t·ª±: <br>
    <code>1‚Äì6: (empty)</code> ‚Ä¢ <code>7‚Äì12: English A1,B1,A2,B2,A3,B3</code> ‚Ä¢ <code>13‚Äì18: Êó•Êú¨Ë™û A1,B1,A2,B2,A3,B3</code><br>
    D√°n nhi·ªÅu h·ªôi tho·∫°i; m·ªói h·ªôi tho·∫°i ph·∫£i c√≥ 2 ph·∫ßn: <b>üë• Êó•Êú¨Ë™û</b> v√† <b>üí¨ English</b>.
  </div>

  <div class="row">
    <button class="btn" id="btnExample">D√°n v√≠ d·ª•</button>
    <button class="btn" id="btnPreview">Preview</button>
    <button class="btn primary" id="btnDownload">T·∫£i CSV</button>
    <label><input type="checkbox" id="chkDedup" checked> Lo·∫°i tr√πng theo EN A1</label>
    <span class="status" id="status">0/0 h·ªôi tho·∫°i h·ª£p l·ªá</span>
  </div>

  <textarea id="input" placeholder="üë• Êó•Êú¨Ë™û
A: ...
B: ...
...
üí¨ English
A: ...
B: ...
...

üë• Êó•Êú¨Ë™û
A: ...
B: ...
...
üí¨ English
A: ...
B: ...
..."></textarea>

  <div id="preview"></div>

<script>
// ===== Helpers =====
function norm(s){return (s||"").replace(/\r\n/g,"\n").replace(/\r/g,"\n");}
function escapeHTML(x){return String(x??"").replace(/&/g,"&amp;").replace(/</g,"&lt;");}

// T√°ch th√†nh c√°c block, m·ªói block b·∫Øt ƒë·∫ßu t·∫°i d√≤ng ch·ª©a 'Êó•Êú¨Ë™û' (c√≥ th·ªÉ c√≥ emoji üë•)
function splitBlocks(all){
  const t = norm(all).trim();
  if(!t) return [];
  // C·∫Øt tr∆∞·ªõc m·ªói ti√™u ƒë·ªÅ Êó•Êú¨Ë™û ·ªü ƒë·∫ßu d√≤ng (multiline)
  const parts = t.split(/(?=^[ \t]*(?:üë•\s*)?Êó•Êú¨Ë™û[ \t]*$)/m).filter(x=>x.trim());
  return parts;
}

// L·∫•y c√°c d√≤ng sau headerRegex cho ƒë·∫øn tr∆∞·ªõc header ti·∫øp theo
function extractSection(lines, headerRegex){
  let start = -1;
  for(let i=0;i<lines.length;i++){
    if(headerRegex.test(lines[i])){ start = i+1; break; }
  }
  if(start<0) return [];
  const out=[];
  for(let i=start;i<lines.length;i++){
    const line = lines[i];
    if(/^[ \t]*(?:üë•\s*)?Êó•Êú¨Ë™û[ \t]*$/.test(line) || /^[ \t]*(?:üí¨\s*)?English[ \t]*$/i.test(line)){
      break;
    }
    out.push(line);
  }
  return out;
}

// Tr√≠ch c√°c l∆∞·ª£t A/B; tr·∫£ v·ªÅ m·∫£ng [A1,B1,A2,B2,A3,B3], thi·∫øu th√¨ ƒëi·ªÅn r·ªóng
function pickTurns(sectionLines){
  const turns=[];
  for(const raw of sectionLines){
    const m = raw.match(/^\s*([AB])\s*:\s*(.+)\s*$/);
    if(m){ turns.push({speaker:m[1], text:m[2]}); }
  }
  const out = Array(6).fill("");
  let a=0,b=0;
  for(const t of turns){
    if(t.speaker==="A" && a<3){ out[2*a] = t.text; a++; }
    if(t.speaker==="B" && b<3){ out[2*b+1] = t.text; b++; }
  }
  return out;
}

// Parse 1 block ‚Üí row 18 c·ªôt + ƒë√°nh gi√° h·ª£p l·ªá
function parseOneBlock(blockText){
  const lines = norm(blockText).split("\n").map(s=>s.trimEnd());
  const jpLines = extractSection(lines, /^[ \t]*(?:üë•\s*)?Êó•Êú¨Ë™û[ \t]*$/);
  const enLines = extractSection(lines, /^[ \t]*(?:üí¨\s*)?English[ \t]*$/i);

  if(!jpLines.length || !enLines.length) {
    return { ok:false, reason:"Thi·∫øu ph·∫ßn Êó•Êú¨Ë™û ho·∫∑c English", row:null, meta:{enA1:""} };
  }

  const jp6 = pickTurns(jpLines);
  const en6 = pickTurns(enLines);

  // √≠t nh·∫•t c·∫ßn c√≥ c·∫∑p A1/B1 ·ªü c·∫£ JP v√† EN
  const jpPair = (jp6[0] && jp6[1]);
  const enPair = (en6[0] && en6[1]);

  const row = Array(18).fill("");
  for(let i=0;i<6;i++){ row[6+i]  = en6[i]; }  // 7..12
  for(let i=0;i<6;i++){ row[12+i] = jp6[i]; }  // 13..18

  const ok = jpPair && enPair;
  return { ok, reason: ok?"":"Thi·∫øu t·ªëi thi·ªÉu c·∫∑p A1/B1", row, meta:{enA1: en6[0]||""} };
}

// Parse to√†n b·ªô input
function parseAll(input){
  const blocks = splitBlocks(input);
  const rows=[]; const issues=[]; const metas=[];
  blocks.forEach((blk, idx)=>{
    const r = parseOneBlock(blk);
    if(r.ok){ rows.push(r.row); metas.push({index: idx+1, enA1: r.meta.enA1}); }
    else { issues.push({index: idx+1, reason: r.reason}); }
  });
  return { rows, issues, metas, total: blocks.length };
}

// CSV kh√¥ng header, auto-quote
function toCSVNoHeader(rows){
  const esc = v=>{
    const s=String(v??"");
    const need=/[",\n]/.test(s);
    const e=s.replace(/"/g,'""');
    return need?`"${e}"`:e;
  };
  return rows.map(r=>r.map(esc).join(",")).join("\n");
}

function downloadCSV(filename, text){
  const blob = new Blob(["\uFEFF"+text], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); },0);
}

// ===== UI logic =====
const EXAMPLE = `üë• Êó•Êú¨Ë™û
A: ÊòéÊó•ÊôÇÈñì„ÅÇ„ÇãÔºü
B: „ÅÜ„Çì„ÄÅÂçàÂæå„Å™„ÇâÂ§ß‰∏àÂ§´„ÄÇ
A: Êò†ÁîªË¶ã„Å´Ë°å„Åã„Å™„ÅÑÔºü
B: „ÅÑ„ÅÑ„Å≠ÔºÅ‰ΩïÊôÇ„Å´„Åô„ÇãÔºü

üí¨ English
A: Are you free tomorrow?
B: Yeah, afternoon works.
A: Want to go see a movie?
B: Sounds good! What time?

üë• Êó•Êú¨Ë™û
A: „Å°„Çá„Å£„Å®ÁÜ±„Å£„ÅΩ„ÅÑ„Çì„Å†„Åë„Å©„ÄÅ‰ªäÊó•ÁóÖÈô¢„Å´Ë°å„Å£„Åü„Åª„ÅÜ„Åå„ÅÑ„ÅÑ„Åã„Å™Ôºü
B: „ÅÜ„Çì„ÄÅ„Åù„ÅÆ„Åª„ÅÜ„Åå„ÅÑ„ÅÑ„Å®ÊÄù„ÅÜ„Çà„ÄÇÈ†≠Áóõ„Å®„Åã„ÅØ„ÅÇ„ÇãÔºü
A: Â∞ë„Åó„Å†„Åë„ÄÇ„ÅÇ„Å®„ÄÅÊò®Êó•„Åã„ÇâÂñâ„ÇÇÁóõ„ÅÑ„Çì„Å†„ÄÇ
B: „Åò„ÇÉ„ÅÇ„ÄÅÂÜÖÁßë„Å´Ë°å„Åè„Å®„ÅÑ„ÅÑ„Çà„ÄÇËøë„Åè„Å´„ÅÑ„ÅÑÁóÖÈô¢„Åå„ÅÇ„Çã„Çà„ÄÇ
A: „ÅÇ„Çä„Åå„Å®„ÅÜ„ÄÇ‰∫àÁ¥Ñ„ÅåÂøÖË¶Å„Åã„Å™Ôºü
B: ÂçàÂâç‰∏≠„Å™„Çâ‰∫àÁ¥Ñ„Å™„Åó„Åß„ÇÇË®∫„Å¶„ÇÇ„Çâ„Åà„Çã„ÅØ„Åö„Å†„Çà„ÄÇ

üí¨ English
A: I feel a bit feverish. Do you think I should go to the hospital today?
B: Yeah, I think that‚Äôs a good idea. Do you have a headache, too?
A: A little. And my throat has been sore since yesterday.
B: Then you should go to the internal medicine department. There‚Äôs a good clinic nearby.
A: Thanks. Do I need to make an appointment?
B: If you go in the morning, they should see you without one.
`;

const $input = document.getElementById("input");
const $status = document.getElementById("status");
const $preview = document.getElementById("preview");
const $chk = document.getElementById("chkDedup");

function currentParsed(){
  const parsed = parseAll($input.value);
  // Dedup theo EN A1 (ti·ªán ƒë·ªÉ lo·∫°i tr√πng block)
  if($chk.checked){
    const seen = new Set();
    const keepRows=[]; const keepMetas=[];
    parsed.rows.forEach((row, i)=>{
      const key = parsed.metas[i]?.enA1 || "";
      if(!seen.has(key)){
        seen.add(key);
        keepRows.push(row);
        keepMetas.push(parsed.metas[i]);
      }
    });
    parsed.rows = keepRows;
    parsed.metas = keepMetas;
  }
  return parsed;
}

function renderPreview(rows, issues, metas){
  if(!rows.length){
    $preview.innerHTML = issues.length
      ? `<div class="warn">Kh√¥ng c√≥ h·ªôi tho·∫°i h·ª£p l·ªá.<br>L·ªói: ${
          issues.map(i=>`#${i.index} (${escapeHTML(i.reason)})`).join("; ")
        }</div>`
      : "";
    return;
  }
  const head = `<tr>
    <th>#</th>
    <th>7 EN A1</th><th>8 EN B1</th><th>9 EN A2</th><th>10 EN B2</th><th>11 EN A3</th><th>12 EN B3</th>
    <th>13 JP A1</th><th>14 JP B1</th><th>15 JP A2</th><th>16 JP B2</th><th>17 JP A3</th><th>18 JP B3</th>
  </tr>`;
  const body = rows.slice(0,5).map((r,idx)=>{
    const no = (metas[idx]?.index ?? idx+1);
    const cells = r.slice(6).map(c=>`<td>${escapeHTML(c)}</td>`).join("");
    return `<tr><td class="muted">#${no}</td>${cells}</tr>`;
  }).join("");
  const issueNote = issues.length ? `<div class="warn">B·ªè qua ${issues.length} h·ªôi tho·∫°i l·ªói: ${issues.map(i=>`#${i.index}`).join(", ")}</div>` : "";
  $preview.innerHTML = `<table>${head}${body}</table><div class="status">Xem tr∆∞·ªõc t·ªëi ƒëa 5 h·ªôi tho·∫°i ‚Ä¢ T·ªïng h·ª£p l·ªá: ${rows.length}</div>${issueNote}`;
}

document.getElementById("btnExample").addEventListener("click", ()=>{
  $input.value = EXAMPLE;
  const {rows,issues,metas,total} = currentParsed();
  document.getElementById("status").textContent = `${rows.length}/${total} h·ªôi tho·∫°i h·ª£p l·ªá`;
  renderPreview(rows, issues, metas);
});

document.getElementById("btnPreview").addEventListener("click", ()=>{
  const {rows,issues,metas,total} = currentParsed();
  document.getElementById("status").textContent = `${rows.length}/${total} h·ªôi tho·∫°i h·ª£p l·ªá`;
  renderPreview(rows, issues, metas);
});

document.getElementById("btnDownload").addEventListener("click", ()=>{
  const {rows,issues,metas,total} = currentParsed();
  if(!rows.length){
    alert("Kh√¥ng c√≥ h·ªôi tho·∫°i h·ª£p l·ªá ƒë·ªÉ xu·∫•t.");
    return;
  }
  const csv = toCSVNoHeader(rows);
  downloadCSV("anki_dialogue_18fields.csv", csv);
});

$input.addEventListener("input", ()=>{
  const {rows,total} = currentParsed();
  document.getElementById("status").textContent = `${rows.length}/${total} h·ªôi tho·∫°i h·ª£p l·ªá`;
});
</script>
</body>
</html>
