<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Anki Dialogue → CSV (17 fields, pipe-delimited)</title>
<style>
  :root { --pad:16px; }
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Arial,sans-serif;margin:var(--pad);}
  h1{font-size:22px;margin:0 0 8px}
  .hint{color:#555;font-size:14px;margin-bottom:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .btn{padding:12px 16px;border:1px solid #ccc;border-radius:10px;background:#f4f4f6;cursor:pointer;font-size:16px}
  .btn.primary{background:#0b5fff;border-color:#0b5fff;color:#fff}
  .btn:active{transform:translateY(1px)}
  textarea{width:100%;height:50vh;padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:15px;line-height:1.5;border:1px solid #ddd;border-radius:10px}
  .status{font-size:14px;color:#444}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{border:1px solid #eee;padding:6px;vertical-align:top}
  th{background:#fafafa;text-align:left}
  .warn{color:#b00020}
  .muted{color:#666}
</style>
</head>
<body>
  <h1>Anki Dialogue → CSV (17 fields)</h1>
  <div class="hint">
    Xuất <b>CSV 17 cột (không header)</b> với <b>delimiter = “|”</b>: <br>
    <code>1–5: (empty)</code> • <code>6–11: English A1,B1,A2,B2,A3,B3</code> • <code>12–17: 日本語 A1,B1,A2,B2,A3,B3</code>
  </div>

  <div class="row">
    <button class="btn" id="btnExample">Dán ví dụ</button>
    <button class="btn" id="btnPreview">Preview</button>
    <button class="btn primary" id="btnDownload">Tải CSV</button>
    <span class="status" id="status">0/0 hội thoại hợp lệ</span>
  </div>

  <textarea id="input" placeholder="👥 日本語
A: ...
B: ...
...
💬 English
A: ...
B: ...
..."></textarea>

  <div id="preview"></div>

<script>
// ===== Helpers =====
function norm(s){return (s||"").replace(/\r\n/g,"\n").replace(/\r/g,"\n");}
function escapeHTML(x){return String(x??"").replace(/&/g,"&amp;").replace(/</g,"&lt;");}

// Tách block theo tiêu đề 日本語
function splitBlocks(all){
  const t = norm(all).trim();
  if(!t) return [];
  return t.split(/(?=^[ \t]*(?:👥\s*)?日本語[ \t]*$)/m).filter(x=>x.trim());
}

// Lấy các câu trong section
function extractSection(lines, headerRegex){
  let start = -1;
  for(let i=0;i<lines.length;i++){
    if(headerRegex.test(lines[i])){ start = i+1; break; }
  }
  if(start<0) return [];
  const out=[];
  for(let i=start;i<lines.length;i++){
    const line = lines[i];
    if(/^[ \t]*(?:👥\s*)?日本語[ \t]*$/.test(line) || /^[ \t]*(?:💬\s*)?English[ \t]*$/i.test(line)){
      break;
    }
    out.push(line);
  }
  return out;
}

// Lấy A/B theo thứ tự, tối đa 3 cặp, thiếu thì điền ""
function pickTurns(sectionLines){
  const turns=[];
  for(const raw of sectionLines){
    const m = raw.match(/^\s*([AB])\s*:\s*(.+)\s*$/);
    if(m){ turns.push({speaker:m[1], text:m[2]}); }
  }
  const out = Array(6).fill("");
  let a=0,b=0;
  for(const t of turns){
    if(t.speaker==="A" && a<3){ out[2*a] = t.text; a++; }
    if(t.speaker==="B" && b<3){ out[2*b+1] = t.text; b++; }
  }
  return out;
}

// Parse 1 block → row 17 cột
function parseOneBlock(blockText){
  const lines = norm(blockText).split("\n").map(s=>s.trimEnd());
  const jpLines = extractSection(lines, /^[ \t]*(?:👥\s*)?日本語[ \t]*$/);
  const enLines = extractSection(lines, /^[ \t]*(?:💬\s*)?English[ \t]*$/i);

  if(!jpLines.length || !enLines.length) {
    return { ok:false, reason:"Thiếu phần 日本語 hoặc English", row:null };
  }

  const jp6 = pickTurns(jpLines);
  const en6 = pickTurns(enLines);

  const hasPair = (en6[0] && en6[1]); // ít nhất phải có A1/B1 EN

  // Tạo 17 cột: 1–5 trống, 6–11 EN, 12–17 JP
  const row = Array(17).fill("");
  for(let i=0;i<6;i++){ row[5+i]  = en6[i]; }  // 6..11
  for(let i=0;i<6;i++){ row[11+i] = jp6[i]; }  // 12..17

  return { ok: hasPair, reason: hasPair?"":"Thiếu cặp A1/B1 EN", row };
}

// Parse toàn bộ input
function parseAll(input){
  const blocks = splitBlocks(input);
  const rows=[]; const issues=[];
  blocks.forEach((blk, idx)=>{
    const r = parseOneBlock(blk);
    if(r.ok){ rows.push(r.row); }
    else { issues.push({index:idx+1, reason:r.reason}); }
  });
  return { rows, issues, total: blocks.length };
}

// CSV không header, delimiter = '|'
function toCSVNoHeader(rows){
  const esc = v=>{
    const s=String(v??"");
    return s.includes("|") || s.includes("\n") ? `"${s.replace(/"/g,'""')}"` : s;
  };
  return rows.map(r=>r.map(esc).join("|")).join("\n");
}

function downloadCSV(filename, text){
  const blob = new Blob(["\uFEFF"+text], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); },0);
}

// ===== UI logic =====
const EXAMPLE = `👥 日本語
A: 明日時間ある？
B: うん、午後なら大丈夫。
A: 映画見に行かない？
B: いいね！何時にする？

💬 English
A: Are you free tomorrow?
B: Yeah, afternoon works.
A: Want to go see a movie?
B: Sounds good! What time?

👥 日本語
A: ちょっと熱っぽいんだけど、今日病院に行ったほうがいいかな？
B: うん、そのほうがいいと思うよ。頭痛とかはある？
A: 少しだけ。あと、昨日から喉も痛いんだ。
B: じゃあ、内科に行くといいよ。近くにいい病院があるよ。
A: ありがとう。予約が必要かな？
B: 午前中なら予約なしでも診てもらえるはずだよ。

💬 English
A: I feel a bit feverish. Do you think I should go to the hospital today?
B: Yeah, I think that’s a good idea. Do you have a headache, too?
A: A little. And my throat has been sore since yesterday.
B: Then you should go to the internal medicine department. There’s a good clinic nearby.
A: Thanks. Do I need to make an appointment?
B: If you go in the morning, they should see you without one.
`;

const $input = document.getElementById("input");
const $status = document.getElementById("status");
const $preview = document.getElementById("preview");

function currentParsed(){
  return parseAll($input.value);
}

function renderPreview(rows, issues){
  if(!rows.length){
    $preview.innerHTML = issues.length
      ? `<div class="warn">Không có hội thoại hợp lệ.<br>Lỗi: ${
          issues.map(i=>`#${i.index} (${escapeHTML(i.reason)})`).join("; ")
        }</div>`
      : "";
    return;
  }
  const head = `<tr>
    <th>#</th>
    <th>EN A1</th><th>EN B1</th><th>EN A2</th><th>EN B2</th><th>EN A3</th><th>EN B3</th>
    <th>JP A1</th><th>JP B1</th><th>JP A2</th><th>JP B2</th><th>JP A3</th><th>JP B3</th>
  </tr>`;
  const body = rows.slice(0,5).map((r,idx)=>{
    const cells = r.slice(5).map(c=>`<td>${escapeHTML(c)}</td>`).join("");
    return `<tr><td class="muted">#${idx+1}</td>${cells}</tr>`;
  }).join("");
  const issueNote = issues.length ? `<div class="warn">Bỏ qua ${issues.length} hội thoại lỗi</div>` : "";
  $preview.innerHTML = `<table>${head}${body}</table><div class="status">Xem trước tối đa 5 hội thoại • Tổng hợp lệ: ${rows.length}</div>${issueNote}`;
}

document.getElementById("btnExample").addEventListener("click", ()=>{
  $input.value = EXAMPLE;
  const {rows,issues,total} = currentParsed();
  $status.textContent = `${rows.length}/${total} hội thoại hợp lệ`;
  renderPreview(rows, issues);
});

document.getElementById("btnPreview").addEventListener("click", ()=>{
  const {rows,issues,total} = currentParsed();
  $status.textContent = `${rows.length}/${total} hội thoại hợp lệ`;
  renderPreview(rows, issues);
});

document.getElementById("btnDownload").addEventListener("click", ()=>{
  const {rows,issues,total} = currentParsed();
  if(!rows.length){
    alert("Không có hội thoại hợp lệ để xuất.");
    return;
  }
  const csv = toCSVNoHeader(rows);
  downloadCSV("anki_dialogue_17fields.csv", csv);
});

$input.addEventListener("input", ()=>{
  const {rows,total} = currentParsed();
  $status.textContent = `${rows.length}/${total} hội thoại hợp lệ`;
});
</script>
</body>
</html>
